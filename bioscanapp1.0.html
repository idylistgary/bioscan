<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BioScan">

    <title>BioScan Pro - ÊâãÈÉ®Á¥∞ËèåÂàÜÊûêÂÑÄ</title>
    <style>
        :root {
            --primary-color: #00f3ff;
            --bg-color: #000000; /* ÊâãÊ©üÁâàÊîπÁ¥îÈªëÊõ¥ÁúÅÈõª‰∏îÊúâË≥™ÊÑü */
            --panel-bg: #111111;
            --text-color: #ffffff;
            --accent-color: #ff0055;
            --success-color: #00ff9d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* Èò≤Ê≠¢ÊâãÊ©ü‰∏ãÊãâÈáçÊï¥ */
            overscroll-behavior: none; 
        }

        /* App Header */
        header {
            width: 100%;
            text-align: center;
            padding: 20px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        h1 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin: 0;
            letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.6);
        }

        .subtitle {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        /* Main Camera Button */
        .camera-btn-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 243, 255, 0.1) 0%, transparent 70%);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px dashed #333;
            transition: all 0.3s;
        }

        .camera-btn-container:active {
            transform: scale(0.95);
            border-color: var(--primary-color);
        }

        .camera-icon {
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 0 0 20px var(--primary-color);
        }

        /* Result Panel */
        .result-panel {
            width: 100%;
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 20px;
            box-sizing: border-box;
            margin-top: 20px;
            border: 1px solid #333;
            display: none; /* Hidden by default */
        }

        .grid-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            background: #000;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #222;
        }

        .stat-label { font-size: 0.7rem; color: #888; margin-bottom: 5px; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }

        .big-rating {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 15px;
        }

        /* Image Preview */
        .preview-container {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: none;
            margin-bottom: 15px;
        }

        #preview-img { width: 100%; height: 100%; object-fit: contain; }

        /* Scanning Line */
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
            animation: scan 1.5s linear infinite;
            display: none;
        }
        @keyframes scan { 0% {top: 0%;} 100% {top: 100%;} }

        /* Buttons */
        .action-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 20px rgba(0,243,255,0.3);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #444;
            color: #888;
        }

        /* Hidden elements */
        #file-input { display: none; }
        #process-canvas { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>BioScan</h1>
        <div class="subtitle">ÈäòÂÇ≥ÂúãÂ∞èÁßëÂ±ïÂ∞àÁî®ÁµÇÁ´Ø</div>
    </header>

    <input type="file" id="file-input" accept="image/*" capture="environment">
    
    <div class="camera-btn-container" onclick="document.getElementById('file-input').click()" id="scan-btn">
        <div style="text-align: center;">
            <div class="camera-icon">üì∑</div>
            <div style="margin-top: 10px; font-size: 0.9rem; color: #aaa;">ÈªûÊìäÊéÉÊèèÂüπÈ§äÁöø<br>(TAP TO SCAN)</div>
        </div>
    </div>

    <div class="preview-container" id="preview-box">
        <img id="preview-img">
        <div class="scan-line" id="scan-line"></div>
    </div>

    <div style="text-align: center; color: var(--primary-color); font-family: monospace; margin: 10px 0; display:none;" id="status-text">
        ANALYZING...
    </div>

    <div class="result-panel" id="result-panel">
        <div class="big-rating" id="res-rating">--</div>
        
        <div class="grid-stats">
            <div class="stat-item">
                <div class="stat-label">‰∫ÆÂ∫¶ (BRIGHTNESS)</div>
                <div class="stat-val" id="res-brightness">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ËÆäÁï∞Êï∏ (VARIANCE)</div>
                <div class="stat-val" id="res-variance">0</div>
            </div>
        </div>

        <button class="action-btn btn-secondary" onclick="resetScan()">ÈáçÊñ∞ÊéÉÊèè (RESET)</button>
    </div>

    <div style="width: 100%; margin-top: 30px;">
        <h3 style="border-left: 3px solid var(--primary-color); padding-left: 10px; margin-bottom: 10px;">Ê≠∑Âè≤Á¥ÄÈåÑ (HISTORY)</h3>
        <div id="history-list" style="font-size: 0.8rem; color: #ccc;">
            </div>
        <button onclick="exportExcel()" style="background:none; border:none; color: #666; width:100%; padding:20px; text-decoration: underline;">ÂåØÂá∫Êï∏Êìö</button>
    </div>

    <canvas id="process-canvas"></canvas>

    <script>
        const fileInput = document.getElementById('file-input');
        const scanBtn = document.getElementById('scan-btn');
        const previewBox = document.getElementById('preview-box');
        const previewImg = document.getElementById('preview-img');
        const scanLine = document.getElementById('scan-line');
        const statusText = document.getElementById('status-text');
        const resultPanel = document.getElementById('result-panel');
        const historyList = document.getElementById('history-list');
        
        let logs = [];

        fileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    // UI Transition
                    scanBtn.style.display = 'none';
                    previewBox.style.display = 'block';
                    previewImg.src = e.target.result;
                    
                    // Start Scan Effect
                    scanLine.style.display = 'block';
                    statusText.style.display = 'block';
                    
                    // Simulate processing
                    setTimeout(analyzeImage, 1500);
                }
                reader.readAsDataURL(file);
            }
        });

        function analyzeImage() {
            const canvas = document.getElementById('process-canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Resize
                const scale = 500 / img.width;
                canvas.width = 500;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Center Crop 50%
                const w = canvas.width * 0.5;
                const h = canvas.height * 0.5;
                const imageData = ctx.getImageData(canvas.width * 0.25, canvas.height * 0.25, w, h);
                const data = imageData.data;
                
                let totalBri = 0;
                let briArr = [];

                for(let i=0; i<data.length; i+=4) {
                    const b = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
                    totalBri += b;
                    briArr.push(b);
                }

                const mean = totalBri / briArr.length;
                
                let sumSq = 0;
                for(let b of briArr) sumSq += Math.pow(b - mean, 2);
                const variance = sumSq / briArr.length;

                showResult(mean, variance);
            };
            img.src = previewImg.src;
        }

        function showResult(mean, variance) {
            scanLine.style.display = 'none';
            statusText.style.display = 'none';
            resultPanel.style.display = 'block';

            const meanFix = mean.toFixed(1);
            const varFix = Math.round(variance);

            // Rating Logic
            let rate = "ÊôÆÈÄö";
            let color = "yellow";
            if(mean < 155) { rate = "CLEAN (Ê•µÊ∑®)"; color = "#00ff9d"; }
            else if(mean > 190) { rate = "DIRTY (ÁîüÁâ©ËÜú)"; color = "#ff0055"; }
            else { rate = "ACCEPTABLE (Â∞öÂèØ)"; color = "#00f3ff"; }

            document.getElementById('res-rating').innerText = rate;
            document.getElementById('res-rating').style.color = color;
            document.getElementById('res-rating').style.border = `1px solid ${color}`;
            
            document.getElementById('res-brightness').innerText = meanFix;
            document.getElementById('res-variance').innerText = varFix;

            // Add to History
            const logItem = document.createElement('div');
            logItem.style = "padding: 10px; border-bottom: 1px solid #333; display:flex; justify-content:space-between;";
            logItem.innerHTML = `<span>ÊéÉÊèè #${logs.length+1}</span> <span style="color:${color}">${meanFix} / ${rate}</span>`;
            historyList.prepend(logItem);
            
            logs.push([logs.length+1, meanFix, varFix, rate]);
        }

        function resetScan() {
            fileInput.value = '';
            resultPanel.style.display = 'none';
            previewBox.style.display = 'none';
            scanBtn.style.display = 'flex';
        }

        function exportExcel() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFFID,Brightness,Variance,Rating\n";
            logs.forEach(row => {
                csvContent += row.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "bioscan_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>